<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCA++ | LLVM MCA Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
            height: 100vh; 
        }

        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh; 
        }

        .header {
            height: 60px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .arch-selector {
            display: flex;
            background: #0d1117;
            border-radius: 6px;
            padding: 4px;
            gap: 4px;
        }

        .arch-btn {
            padding: 8px 16px;
            background: transparent;
            color: #8b949e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .arch-btn.active {
            background: #1f6feb;
            color: #fff;
        }

        .arch-btn:hover:not(.active) {
            background: #21262d;
            color: #c9d1d9;
        }

        .run-btn {
            padding: 8px 20px;
            background: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .select-all-btn {
            background: #30363d;
        }
        
        .select-all-btn:hover {
            background: #484f58;
        }

        .run-btn:hover {
            background: #2ea043;
        }

        .run-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .main-container {
            display: flex;
            flex-grow: 1; 
            position: relative;
            overflow: hidden;
        }

        .left-panel {
            background: #0d1117;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            min-width: 300px;
            width: 45%;
        }

        .code-header {
            padding: 12px 16px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            font-size: 13px;
            color: #8b949e;
            flex-shrink: 0;
        }

        .code-editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #code-input {
            flex: 1;
            width: 100%;
            background: #0d1117;
            border: none;
            outline: none;
            color: #c9d1d9;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            padding: 16px;
            overflow: auto;
        }

        #code-input::-webkit-scrollbar { width: 10px; }
        #code-input::-webkit-scrollbar-track { background: #0d1117; }
        #code-input::-webkit-scrollbar-thumb { background: #30363d; border-radius: 5px; }
        #code-input::-webkit-scrollbar-thumb:hover { background: #484f58; }

        .resizer {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
        }

        .resizer:hover {
            background: #1f6feb;
        }

        .resizer.resizing {
            background: #1f6feb;
        }

        .right-panel {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            min-width: 300px;
        }

        .right-panel::-webkit-scrollbar { width: 10px; }
        .right-panel::-webkit-scrollbar-track { background: #0d1117; }
        .right-panel::-webkit-scrollbar-thumb { background: #30363d; border-radius: 5px; }
        .right-panel::-webkit-scrollbar-thumb:hover { background: #484f58; }

        .score-section {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .score-card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            min-width: 250px;
        }
        .score-title { font-size: 16px; color: #8b949e; margin-bottom: 16px; }
        .circular-progress { position: relative; width: 140px; height: 140px; margin: 0 auto; }
        .progress-ring-circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; stroke: #21262d; }
        .progress-ring-circle.active { stroke: #58a6ff; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: 600; color: #58a6ff; }

        .architecture-section, .ai-summary { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
        .section-title, .ai-summary-title { font-size: 18px; font-weight: 600; color: #c9d1d9; margin-bottom: 16px; border-bottom: 1px solid #30363d; padding-bottom: 8px; }
        
        .arch-diagram { display: flex; justify-content: center; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .pipeline-stage { text-align: center; min-width: 100px; }
        .stage-title { font-size: 14px; color: #8b949e; margin-bottom: 8px; }
        .stage-box { 
            background: #21262d; 
            border: 2px solid #30363d; 
            border-radius: 6px; 
            padding: 12px 10px; 
            margin-bottom: 6px; 
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        /* Pressure color coding */
        .stage-box.low-pressure { 
            background: rgba(88, 166, 255, 0.15);
            border-color: #58a6ff; 
            color: #58a6ff;
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.3);
        }
        
        .stage-box.medium-pressure { 
            background: rgba(255, 165, 0, 0.15);
            border-color: #fb8500; 
            color: #fb8500;
            box-shadow: 0 0 8px rgba(251, 133, 0, 0.3);
        }
        
        .stage-box.high-pressure { 
            background: rgba(248, 81, 73, 0.15);
            border-color: #f85149; 
            color: #f85149;
            box-shadow: 0 0 8px rgba(248, 81, 73, 0.4);
        }
        
        .arrow { font-size: 24px; color: #30363d; margin-top: 30px; }

        .ai-summary-content { font-size: 14px; line-height: 1.6; color: #8b949e; }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
                height: 50vh; 
                border-right: none;
                border-bottom: 1px solid #30363d;
            }
            .right-panel {
                width: 100%;
                height: auto;
                padding: 16px;
            }
            .resizer {
                height: 4px;
                width: 100%;
                cursor: row-resize;
            }
            .header {
                padding: 0 16px;
            }
            .score-section {
                flex-direction: column;
                align-items: center;
            }
        }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <header class="header">
            <div class="logo">MCA++</div>
            <div class="header-controls">
                <div class="arch-selector">
                    <button class="arch-btn active" data-arch="npu">Ethos</button>
                    <button class="arch-btn" data-arch="cortexa">CortexA</button>
                </div>
                <button class="run-btn select-all-btn">Select All</button>
                <button class="run-btn" id="analyze-btn">Analyze Code</button>
            </div>
        </header>

        <div class="main-container">
            <div class="left-panel">
                <div class="code-header">C++ Code Editor</div>
                <div class="code-editor-wrapper">
                    <textarea id="code-input" spellcheck="false" placeholder="Write your C++ code here..."></textarea>
                </div>
            </div>

            <div class="resizer"></div>

            <div class="right-panel">
                <div class="score-section">
                    <div class="score-card">
                        <div class="score-title">Efficiency Score</div>
                        <div class="circular-progress" id="efficiency-progress">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring-circle" stroke-width="8" fill="transparent" r="62" cx="70" cy="70"/>
                                <circle class="progress-ring-circle active" stroke-width="8" fill="transparent" r="62" cx="70" cy="70" 
                                        style="stroke-dasharray: 389.557; stroke-dashoffset: 389.557;"/>
                            </svg>
                            <div class="progress-text">--%</div>
                        </div>
                    </div>
                </div>

                <div class="architecture-section">
                    <div class="section-title" id="arch-title">NPU Architecture</div>
                    <div class="arch-diagram" id="npu-diagram">
                        <div class="pipeline-stage">
                            <div class="stage-title">Frontend</div>
                            <div class="stage-box" data-stage="frontend-fetch">Fetch</div>
                            <div class="stage-box" data-stage="frontend-decode">Decode</div>
                            <div class="stage-box" data-stage="frontend-queue">Queue</div>
                        </div>
                        
                        <div class="arrow">→</div>
                        
                        <div class="pipeline-stage">
                            <div class="stage-title">Compute</div>
                            <div class="stage-box" data-stage="compute-mac">MAC</div>
                            <div class="stage-box" data-stage="compute-acc">Accumulator</div>
                        </div>
                        
                        <div class="arrow">→</div>
                        
                        <div class="pipeline-stage">
                            <div class="stage-title">Retire</div>
                            <div class="stage-box" data-stage="retire-wb">Writeback</div>
                            <div class="stage-box" data-stage="retire-commit">Commit</div>
                        </div>
                    </div>

                    <div class="arch-diagram" id="cortexa-diagram" style="display: none;">
                        <div class="pipeline-stage">
                            <div class="stage-title">Frontend</div>
                            <div class="stage-box" data-stage="frontend-fetch">Fetch</div>
                            <div class="stage-box" data-stage="frontend-decode">Decode</div>
                            <div class="stage-box" data-stage="frontend-rename">Rename</div>
                        </div>
                        
                        <div class="arrow">→</div>
                        
                        <div class="pipeline-stage">
                            <div class="stage-title">Backend</div>
                            <div class="stage-box" data-stage="backend-intalu">Integer ALU</div>
                            <div class="stage-box" data-stage="backend-fpsimd">FP/SIMD</div>
                            <div class="stage-box" data-stage="backend-loadstore">Load/Store</div>
                        </div>
                        
                        <div class="arrow">→</div>
                        
                        <div class="pipeline-stage">
                            <div class="stage-title">Retire</div>
                            <div class="stage-box" data-stage="retire-commit">Commit</div>
                        </div>
                    </div>
                </div>

                <div class="ai-summary">
                    <div class="ai-summary-title">Analysis Summary</div>
                    <div class="ai-summary-content" id="summary-content">
                        Click "Analyze Code" to run LLVM MCA analysis on your C++ code. Results will include efficiency metrics and pipeline bottleneck identification.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentArch = 'npu';
        let isAnalyzing = false;
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000';

        // Get elements
        const codeInput = document.getElementById('code-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const summaryContent = document.getElementById('summary-content');

        // Initial C++ code template (without headers to avoid include issues)
        const initialCode = `// Simple C++ code for micro-architecture analysis
// Note: Avoid #include if you get compilation errors

int factorial(int n) {
    int result = 1;
    for (int i = 2; i <= n; i++) {
        result *= i;
    }
    return result;
}

int main() {
    int sum = 0;
    for (int i = 0; i < 10; i++) {
        sum += i;
    }
    sum += factorial(5);
    return sum;
}`;

        codeInput.value = initialCode;

        // Resizer functionality
        const resizer = document.querySelector('.resizer');
        const leftPanel = document.querySelector('.left-panel');
        const mainContainer = document.querySelector('.main-container');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const containerRect = mainContainer.getBoundingClientRect();
            const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            if (newWidth > 20 && newWidth < 80) {
                leftPanel.style.width = `${newWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            }
        });

        // Architecture switcher
        const archButtons = document.querySelectorAll('.arch-btn');
        const npuDiagram = document.getElementById('npu-diagram');
        const cortexaDiagram = document.getElementById('cortexa-diagram');
        const archTitle = document.getElementById('arch-title');

        archButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                archButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentArch = btn.dataset.arch;
                if (currentArch === 'npu') {
                    npuDiagram.style.display = 'flex';
                    cortexaDiagram.style.display = 'none';
                    archTitle.textContent = 'NPU Architecture';
                } else {
                    npuDiagram.style.display = 'none';
                    cortexaDiagram.style.display = 'flex';
                    archTitle.textContent = 'CortexA Architecture';
                }
            });
        });

        // Select All button
        document.querySelector('.select-all-btn').addEventListener('click', () => {
            codeInput.focus();
            codeInput.select();
        });

        // Function to update circular progress
        function updateProgress(percentage, element) {
            const circle = element.querySelector('.progress-ring-circle.active');
            const text = element.querySelector('.progress-text');
            const circumference = 2 * Math.PI * 62;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            text.textContent = `${Math.round(percentage)}%`;
        }

        // Function to update pipeline diagram based on analysis results
        function updatePipelineDiagram(pipelineData) {
            // Clear all pressure classes first
            document.querySelectorAll('.stage-box').forEach(box => {
                box.classList.remove('low-pressure', 'medium-pressure', 'high-pressure');
            });

            const activeDiagram = currentArch === 'npu' ? npuDiagram : cortexaDiagram;
            
            // Update frontend stages
            const frontendStatus = pipelineData.frontend_status;
            const frontendClass = frontendStatus.toLowerCase().replace(' ', '-');
            activeDiagram.querySelectorAll('.stage-box[data-stage^="frontend"]').forEach(box => {
                box.classList.add(frontendClass);
            });

            // Update backend/compute stages
            if (currentArch === 'cortexa' && pipelineData.backend_units) {
                const units = pipelineData.backend_units;
                
                // Map backend units to stage boxes
                const unitMapping = {
                    'Integer_ALU': 'backend-intalu',
                    'FP_NEON': 'backend-fpsimd',
                    'Load_Store': 'backend-loadstore'
                };

                Object.keys(unitMapping).forEach(unitKey => {
                    const stageId = unitMapping[unitKey];
                    const stageBox = activeDiagram.querySelector(`[data-stage="${stageId}"]`);
                    if (stageBox && units[unitKey]) {
                        const pressureClass = units[unitKey].pressure.toLowerCase().replace(' ', '-');
                        stageBox.classList.add(pressureClass);
                    }
                });
            } else if (currentArch === 'npu') {
                // For NPU, apply general backend status to compute stages
                const backendStatus = pipelineData.backend_overall_status || 'Low Pressure';
                const backendClass = backendStatus.toLowerCase().replace(' ', '-');
                activeDiagram.querySelectorAll('.stage-box[data-stage^="compute"]').forEach(box => {
                    box.classList.add(backendClass);
                });
            }

            // Retire stages typically have low pressure
            activeDiagram.querySelectorAll('.stage-box[data-stage^="retire"]').forEach(box => {
                box.classList.add('low-pressure');
            });
        }

        // Function to generate summary text
        async function generateSummary(data, code) {
            const scorecard = data.visualization_data.scorecard;
            const pipeline = data.visualization_data.pipeline;
            const targetCpu = data.target_cpu.toUpperCase();

            // Show loading state
            summaryContent.innerHTML = '<span class="loading-spinner"></span> Generating AI summary...';

            try {
                // Call the AI summary endpoint
                const response = await fetch(`${API_BASE_URL}/summarize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysisData: data,
                        code: code
                    })
                });

                const result = await response.json();
                
                if (result.summary) {
                    // Format the AI summary with basic metrics at the top
                    let formattedSummary = `<strong>Target:</strong> ${targetCpu}<br>`;
                    formattedSummary += `<strong>IPC:</strong> ${data.mca_raw_data.IPC} | `;
                    formattedSummary += `<strong>Efficiency:</strong> ${scorecard.efficiency_score}% | `;
                    formattedSummary += `<strong>Cycles Lost:</strong> ${scorecard.cycles_lost}<br><br>`;
                    formattedSummary += `<div style="line-height: 1.8;">${result.summary.replace(/\n/g, '<br>')}</div>`;
                    return formattedSummary;
                }
            } catch (error) {
                console.error('AI summary error:', error);
            }

            // Fallback to basic summary if AI fails
            let summary = `<strong>Target:</strong> ${targetCpu}<br><br>`;
            summary += `<strong>Performance Metrics:</strong><br>`;
            summary += `• Efficiency Score: ${scorecard.efficiency_score}%<br>`;
            summary += `• Cycles Lost to Stalls: ${scorecard.cycles_lost} cycles<br>`;
            summary += `• Ideal Cycles: ${scorecard.ideal_cycles} cycles<br><br>`;

            summary += `<strong>Pipeline Analysis:</strong><br>`;
            summary += `• Frontend Status: ${pipeline.frontend_status} (${pipeline.frontend_ratio} uOps/cycle)<br>`;
            summary += `• Backend IPC: ${pipeline.backend_overall_ipc}<br><br>`;

            if (pipeline.backend_units) {
                summary += `<strong>Backend Unit Pressure:</strong><br>`;
                Object.keys(pipeline.backend_units).forEach(unit => {
                    const unitData = pipeline.backend_units[unit];
                    const unitName = unit.replace('_', ' ');
                    summary += `• ${unitName}: ${unitData.pressure}<br>`;
                });
            }

            return summary;
        }

        // Analyze button click handler
        analyzeBtn.addEventListener('click', async () => {
            if (isAnalyzing) return;

            const code = codeInput.value;
            if (!code.trim()) {
                alert('Please enter some C++ code to analyze.');
                return;
            }

            isAnalyzing = true;
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
            summaryContent.innerHTML = 'Running LLVM MCA analysis... This may take a few seconds.';

            try {
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        target: currentArch
                    })
                });

                const result = await response.json();

                if (result.error) {
                    summaryContent.innerHTML = `<span style="color: #f85149;"><strong>Error:</strong> ${result.error}</span>`;
                    if (result.details) {
                        summaryContent.innerHTML += `<br><br><pre style="background: #0d1117; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 11px; max-height: 400px; overflow-y: auto;">${result.details}</pre>`;
                    }
                } else {
                    // Update efficiency score only (removed wasted potential)
                    const scorecard = result.visualization_data.scorecard;
                    updateProgress(scorecard.efficiency_score, document.getElementById('efficiency-progress'));

                    // Update pipeline diagram with color coding
                    updatePipelineDiagram(result.visualization_data.pipeline);

                    // Update summary with AI
                    summaryContent.innerHTML = '<span class="loading-spinner"></span> Generating AI summary...';
                    const summaryHtml = await generateSummary(result, code);
                    summaryContent.innerHTML = summaryHtml;
                }

            } catch (error) {
                console.error('Analysis error:', error);
                summaryContent.innerHTML = `<span style="color: #f85149;"><strong>Network Error:</strong> Could not connect to the analysis server. Make sure the Node.js server is running on port 3000.</span><br><br>Error details: ${error.message}`;
            } finally {
                isAnalyzing = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Code';
            }
        });
    </script>
</body>
</html>